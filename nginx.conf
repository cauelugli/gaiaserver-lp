#!/bin/bash

# ConfiguraÃ§Ã£o de porta
if [ -n "$PORT" ]; then
  echo "ðŸ”„ Usando porta definida: $PORT"
else
  PORT=8080
  echo "âš ï¸  PORT nÃ£o definido, usando fallback: $PORT"
fi

# ConfiguraÃ§Ã£o NGINX
CONF_FILE="/tmp/nginx.conf"
cat > $CONF_FILE <<"EOF"
worker_processes auto;

events {
    worker_connections 1024;
}

http {
    # ConfiguraÃ§Ã£o mÃ­nima de tipos MIME
    types {
        application/javascript js;
        text/css css;
        text/html html;
    }
    default_type application/octet-stream;

    server {
        listen $PORT;
        server_name _;
        root /var/www/html;

        location ~ \.js$ {
            types { } 
            default_type application/javascript;
            add_header Content-Type application/javascript always;
            try_files $uri =404;
        }

        location / {
            try_files $uri $uri/ /index.html;
        }

        location /api {
            proxy_pass http://localhost:3000;
            proxy_http_version 1.1;
            proxy_set_header Upgrade $http_upgrade;
            proxy_set_header Connection 'upgrade';
        }
    }
}
EOF

# Inicia serviÃ§os
echo "ðŸš€ Iniciando NGINX na porta $PORT"
nginx -c "$CONF_FILE" &

echo "ðŸ”„ Iniciando API Node.js"
node /app/api/index.js &

echo "ðŸ”„ Iniciando Queues"
node /app/queues/mainQueue.js &

echo "âœ… Todos os serviÃ§os rodando"
tail -f /dev/null